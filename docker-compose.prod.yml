# ============================================
# Configuration PRODUCTION VPS avec Traefik
# Commande : docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.prod up -d
# Prerequis : Traefik deploye sur le VPS avec le reseau 'traefik_public'
# ============================================

services:
  mysql:
    container_name: orisha_db_prod
    restart: always
    volumes:
      - mysql_prod_data:/var/lib/mysql
      - ./backups:/backups
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
    # PAS de ports exposes en prod (acces interne uniquement)

  backend:
    image: ${DOCKER_REGISTRY:-}orisha-backend:${VERSION:-latest}
    container_name: orisha_backend_prod
    restart: always
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_NAME: ${DB_NAME}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/swagger-ui/index.html"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - orisha_network
      - traefik_public
    labels:
      # Activation Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"

      # Routeur HTTPS
      - "traefik.http.routers.orisha-api.rule=Host(`api.mountainride.${DOMAIN}`)"
      - "traefik.http.routers.orisha-api.entrypoints=websecure"
      - "traefik.http.routers.orisha-api.tls=true"
      - "traefik.http.routers.orisha-api.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.orisha-api.loadbalancer.server.port=8080"

  frontend:
    image: ${DOCKER_REGISTRY:-}orisha-frontend:${VERSION:-latest}
    container_name: orisha_frontend_prod
    restart: always
    build:
      args:
        VITE_API_URL: https://mountainride-api.${DOMAIN}/api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - orisha_network
      - traefik_public
    labels:
      # Activation Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"

      # Routeur HTTPS
      - "traefik.http.routers.orisha-frontend.rule=Host(`mountainride.${DOMAIN}`)"
      - "traefik.http.routers.orisha-frontend.entrypoints=websecure"
      - "traefik.http.routers.orisha-frontend.tls=true"
      - "traefik.http.routers.orisha-frontend.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.orisha-frontend.loadbalancer.server.port=80"

networks:
  traefik_public:
    external: true

volumes:
  mysql_prod_data:
